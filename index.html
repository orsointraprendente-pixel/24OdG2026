<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24OdG - Torneo Pallascout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#111827">
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    
    <!-- Login Screen -->
    <div id="loginScreen" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 max-w-md w-full">
            <h1 class="text-3xl font-bold text-cyan-400 mb-6 text-center">‚öΩ 24 Ore delle Grazie</h1>
            <p class="text-gray-300 mb-6 text-center">Accedi con email autorizzata</p>
            <input type="email" id="emailInput" placeholder="email@arbitro.it" 
                   class="w-full bg-gray-700 text-white px-4 py-3 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-cyan-400">
            <button onclick="login()" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 rounded-lg transition">
                Accedi
            </button>
            <p id="loginError" class="text-red-400 text-sm mt-4 text-center hidden"></p>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-gray-800 shadow-lg sticky top-0 z-50">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-cyan-400">‚öΩ 24OdG</h1>
                <div class="flex items-center gap-4">
                    <span id="userEmailDisplay" class="text-gray-300 text-sm"></span>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg text-sm transition">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-gray-800 border-t border-gray-700">
            <div class="container mx-auto px-4 flex overflow-x-auto">
                <button onclick="showSection('squadre')" class="nav-btn px-6 py-3 whitespace-nowrap hover:bg-gray-700 transition">
                    üë• Squadre
                </button>
                <button onclick="showSection('partite')" class="nav-btn px-6 py-3 whitespace-nowrap hover:bg-gray-700 transition">
                    üìã Partite
                </button>
                <button onclick="showSection('classifiche')" class="nav-btn px-6 py-3 whitespace-nowrap hover:bg-gray-700 transition">
                    üèÜ Classifiche
                </button>
            </div>
        </nav>

        <!-- Sections Container -->
        <div class="container mx-auto px-4 py-6">
            
            <!-- SQUADRE SECTION -->
            <div id="squadreSection" class="section">
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold text-cyan-400 mb-4">üë• Gestione Squadre</h2>
                    <div class="flex flex-wrap gap-3 mb-4">
                        <input type="text" id="sheetUrlSquadre" placeholder="URL Google Sheets" 
                               class="flex-1 min-w-[200px] bg-gray-700 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-400">
                        <button onclick="importSquadre()" class="bg-green-500 hover:bg-green-600 px-6 py-2 rounded-lg transition">
                            üì• Import Squadre
                        </button>
                        <button onclick="aggiungiSquadraManuale()" class="bg-cyan-500 hover:bg-cyan-600 px-6 py-2 rounded-lg transition">
                            ‚ûï Aggiungi Manuale
                        </button>
                    </div>
                </div>
                
                <div id="squadreList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- PARTITE SECTION -->
            <div id="partiteSection" class="section hidden">
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold text-cyan-400 mb-4">üìã Gestione Partite</h2>
                    <div class="flex flex-wrap gap-3 mb-4">
                        <input type="text" id="sheetUrlPartite" placeholder="URL Google Sheets" 
                               class="flex-1 min-w-[200px] bg-gray-700 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-400">
                        <button onclick="importPartite()" class="bg-green-500 hover:bg-green-600 px-6 py-2 rounded-lg transition">
                            üì• Import Partite
                        </button>
                        <button onclick="aggiungiPartitaManuale()" class="bg-cyan-500 hover:bg-cyan-600 px-6 py-2 rounded-lg transition">
                            ‚ûï Aggiungi Manuale
                        </button>
                    </div>

                    <!-- Filtri Partite -->
                    <div class="flex flex-wrap gap-3 mb-4">
                        <select id="filtroCampo" onchange="loadPartite()" class="bg-gray-700 px-4 py-2 rounded-lg">
                            <option value="">Tutti i campi</option>
                        </select>
                        <select id="filtroOrario" onchange="loadPartite()" class="bg-gray-700 px-4 py-2 rounded-lg">
                            <option value="">Tutti gli orari</option>
                        </select>
                        <select id="filtroStato" onchange="loadPartite()" class="bg-gray-700 px-4 py-2 rounded-lg">
                            <option value="tutte">Tutte</option>
                            <option value="daGiocare">Da Giocare</option>
                            <option value="completate">Completate</option>
                        </select>
                    </div>
                </div>
                
                <!-- Lista Partite (View) -->
                <div id="partiteListView">
                    <div id="partiteList" class="space-y-3"></div>
                </div>

                <!-- Referto Singola Partita (Hidden by default) -->
                <div id="partitaRefertoView" class="hidden">
                    <button onclick="tornaAllePartite()" class="bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-lg mb-4 transition flex items-center gap-2">
                        ‚Üê Torna alle Partite
                    </button>
                    <div id="refertoContent"></div>
                </div>
            </div>

            <!-- CLASSIFICHE SECTION -->
            <div id="classificheSection" class="section hidden">

            <!-- CLASSIFICHE SECTION -->
            <div id="classificheSection" class="section hidden">
                <div class="space-y-6">
                    <!-- Classifica Generale -->
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-cyan-400 mb-4">üèÜ Classifica Generale</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th class="px-4 py-2 text-left">#</th>
                                        <th class="px-4 py-2 text-left">Squadra</th>
                                        <th class="px-4 py-2 text-center">PT</th>
                                        <th class="px-4 py-2 text-center">G</th>
                                        <th class="px-4 py-2 text-center">V</th>
                                        <th class="px-4 py-2 text-center">N</th>
                                        <th class="px-4 py-2 text-center">P</th>
                                        <th class="px-4 py-2 text-center">GF</th>
                                        <th class="px-4 py-2 text-center">GS</th>
                                        <th class="px-4 py-2 text-center">DR</th>
                                    </tr>
                                </thead>
                                <tbody id="classificaGenerale"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Marcatori -->
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-yellow-400 mb-4">‚öΩ Top Marcatori</h2>
                        <div id="topMarcatori" class="space-y-2"></div>
                    </div>

                    <!-- Scalpiatori -->
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-red-400 mb-4">üéØ Top Scalpiatori</h2>
                        <div id="topScalpiatori" class="space-y-2"></div>
                    </div>

                    <!-- Vuotatori -->
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-orange-400 mb-4">‚ùå Top Vuotatori</h2>
                        <div id="topVuotatori" class="space-y-2"></div>
                    </div>

                    <!-- MVP -->
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-cyan-400 mb-4">‚≠ê Top MVP</h2>
                        <div id="topMVP" class="space-y-2"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURAZIONE SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://bflagmexshprrbigcjzj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmbGFnbWV4c2hwcnJiaWdjanpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk2OTk5ODksImV4cCI6MjA0NTI3NTk4OX0.xQdwqXmLvEKkOqmkJZkfvVnGZ5ILqRzUwLmYHq3pMWg';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ============================================
        // WHITELIST EMAIL ARBITRI
        // ============================================
        const ARBITRI_AUTORIZZATI = [
            'stepengo@gmail.com',
            'arbitro1@24odg.it',
            'arbitro2@24odg.it',
            'test@24odg.test'  // Email di test
        ];

        // ============================================
        // AUTENTICAZIONE
        // ============================================
        function checkAuth() {
            const userEmail = localStorage.getItem('userEmail');
            if (userEmail && ARBITRI_AUTORIZZATI.includes(userEmail)) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userEmailDisplay').textContent = userEmail;
                loadSquadre();
                loadPartite();
                showSection('squadre');
            } else {
                localStorage.removeItem('userEmail');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        }

        function login() {
            const email = document.getElementById('emailInput').value.trim().toLowerCase();
            const errorEl = document.getElementById('loginError');
            
            if (!email) {
                errorEl.textContent = 'Inserisci un\'email valida';
                errorEl.classList.remove('hidden');
                return;
            }

            if (ARBITRI_AUTORIZZATI.includes(email)) {
                localStorage.setItem('userEmail', email);
                errorEl.classList.add('hidden');
                checkAuth();
            } else {
                errorEl.textContent = 'Email non autorizzata';
                errorEl.classList.remove('hidden');
            }
        }

        function logout() {
            if (confirm('Vuoi uscire?')) {
                localStorage.removeItem('userEmail');
                checkAuth();
            }
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-gray-700', 'text-cyan-400', 'border-b-2', 'border-cyan-400');
            });
            event.target.classList.add('bg-gray-700', 'text-cyan-400', 'border-b-2', 'border-cyan-400');

            if (sectionName === 'classifiche') {
                loadClassifiche();
            }
            if (sectionName === 'partite') {
                // Torna alla vista lista quando si apre la sezione partite
                tornaAllePartite();
            }
        }

        // ============================================
        // GESTIONE SQUADRE
        // ============================================
        async function loadSquadre() {
            const { data, error } = await supabase
                .from('squadre')
                .select('*')
                .order('nome_squadra', { ascending: true })
                .order('numero', { ascending: true });

            if (error) {
                console.error('Errore caricamento squadre:', error);
                return;
            }

            const squadreByTeam = {};
            data.forEach(row => {
                if (!squadreByTeam[row.nome_squadra]) {
                    squadreByTeam[row.nome_squadra] = [];
                }
                squadreByTeam[row.nome_squadra].push(row);
            });

            const container = document.getElementById('squadreList');
            container.innerHTML = '';

            Object.keys(squadreByTeam).forEach(teamName => {
                const players = squadreByTeam[teamName];
                const card = document.createElement('div');
                card.className = 'bg-gray-800 rounded-lg shadow-lg p-4';
                card.innerHTML = `
                    <h3 class="text-xl font-bold text-cyan-400 mb-3">${teamName}</h3>
                    <div class="space-y-2">
                        ${players.map(p => `
                            <div class="flex items-center gap-2 bg-gray-700 px-3 py-2 rounded">
                                <span class="bg-cyan-500 text-white font-bold px-2 py-1 rounded text-sm">${p.numero}</span>
                                <span>${p.nome_giocatore}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function importSquadre() {
            const url = document.getElementById('sheetUrlSquadre').value.trim();
            if (!url) {
                alert('Inserisci URL Google Sheets');
                return;
            }

            const csvUrl = url.replace('/edit#gid=', '/export?format=csv&gid=').replace('/edit?usp=sharing', '/export?format=csv');
            
            Papa.parse(csvUrl, {
                download: true,
                header: true,
                complete: async function(results) {
                    const rows = results.data.filter(row => row.Squadra && row.Numero && row.Nome);
                    
                    if (rows.length === 0) {
                        alert('Nessun dato valido trovato');
                        return;
                    }

                    for (const row of rows) {
                        await supabase.from('squadre').insert({
                            nome_squadra: row.Squadra.trim(),
                            numero: parseInt(row.Numero),
                            nome_giocatore: row.Nome.trim()
                        });
                    }

                    alert(`Importate ${rows.length} righe!`);
                    loadSquadre();
                },
                error: function(error) {
                    alert('Errore import: ' + error.message);
                }
            });
        }

        async function aggiungiSquadraManuale() {
            const nomeSquadra = prompt('Nome squadra:');
            if (!nomeSquadra) return;

            while (true) {
                const numero = prompt('Numero maglia (lascia vuoto per finire):');
                if (!numero) break;

                const nome = prompt('Nome giocatore:');
                if (!nome) break;

                await supabase.from('squadre').insert({
                    nome_squadra: nomeSquadra.trim(),
                    numero: parseInt(numero),
                    nome_giocatore: nome.trim()
                });
            }

            loadSquadre();
        }

        // ============================================
        // GESTIONE PARTITE
        // ============================================
        async function loadPartite() {
            let query = supabase.from('partite').select('*').order('campo').order('orario');

            const filtroCampo = document.getElementById('filtroCampo').value;
            const filtroOrario = document.getElementById('filtroOrario').value;
            const filtroStato = document.getElementById('filtroStato').value;

            if (filtroCampo) query = query.eq('campo', parseInt(filtroCampo));
            if (filtroOrario) query = query.eq('orario', filtroOrario);
            if (filtroStato === 'daGiocare') query = query.eq('completata', false);
            if (filtroStato === 'completate') query = query.eq('completata', true);

            const { data, error } = await query;

            if (error) {
                console.error('Errore caricamento partite:', error);
                return;
            }

            // Popola filtri
            const campi = [...new Set(data.map(p => p.campo))].sort((a,b) => a-b);
            const orari = [...new Set(data.map(p => p.orario))].sort();

            const filtroCampoEl = document.getElementById('filtroCampo');
            const currentCampo = filtroCampoEl.value;
            filtroCampoEl.innerHTML = '<option value="">Tutti i campi</option>' +
                campi.map(c => `<option value="${c}" ${c == currentCampo ? 'selected' : ''}>Campo ${c}</option>`).join('');

            const filtroOrarioEl = document.getElementById('filtroOrario');
            const currentOrario = filtroOrarioEl.value;
            filtroOrarioEl.innerHTML = '<option value="">Tutti gli orari</option>' +
                orari.map(o => `<option value="${o}" ${o == currentOrario ? 'selected' : ''}>${o}</option>`).join('');

            // Mostra partite in LISTA COMPATTA
            const container = document.getElementById('partiteList');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">Nessuna partita trovata</div>';
                return;
            }

            data.forEach(partita => {
                const card = document.createElement('div');
                card.className = `bg-gray-800 rounded-lg shadow-lg p-4 cursor-pointer hover:bg-gray-700 transition ${partita.completata ? 'opacity-70' : ''}`;
                card.onclick = () => apriReferto(partita.id);
                
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="bg-cyan-500 px-3 py-1 rounded-full text-sm font-bold">Campo ${partita.campo}</span>
                            <span class="bg-gray-700 px-3 py-1 rounded-full text-sm">${partita.orario}</span>
                            ${partita.completata ? '<span class="bg-green-500 px-2 py-1 rounded text-xs">‚úì</span>' : '<span class="bg-yellow-500 text-gray-900 px-2 py-1 rounded text-xs font-bold">DA GIOCARE</span>'}
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold">${partita.squadra_a} <span class="text-2xl text-cyan-400 mx-2">${partita.punteggio_a}</span> - <span class="text-2xl text-cyan-400 mx-2">${partita.punteggio_b}</span> ${partita.squadra_b}</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Funzione per aprire il referto di una partita specifica
        async function apriReferto(partitaId) {
            currentPartitaId = partitaId;

            const { data: partita } = await supabase
                .from('partite')
                .select('*')
                .eq('id', partitaId)
                .single();

            currentPartita = partita;

            const { data: squadraAData } = await supabase
                .from('squadre')
                .select('*')
                .eq('nome_squadra', partita.squadra_a)
                .order('numero');

            const { data: squadraBData } = await supabase
                .from('squadre')
                .select('*')
                .eq('nome_squadra', partita.squadra_b)
                .order('numero');

            giocatoriA = squadraAData || [];
            giocatoriB = squadraBData || [];

            // Reset timer per nuova partita
            pauseTimer();
            timerSeconds = 900;
            currentHalf = 1;
            timerRunning = false;

            // Nascondi lista partite, mostra referto
            document.getElementById('partiteListView').classList.add('hidden');
            document.getElementById('partitaRefertoView').classList.remove('hidden');

            renderReferto();
        }

        // Funzione per tornare alla lista partite
        function tornaAllePartite() {
            // Ferma timer se in esecuzione
            pauseTimer();
            
            document.getElementById('partiteListView').classList.remove('hidden');
            document.getElementById('partitaRefertoView').classList.add('hidden');
            currentPartitaId = null;
            currentPartita = null;
            
            // Reset timer
            timerSeconds = 900;
            currentHalf = 1;
            timerRunning = false;
            
            loadPartite();
        }

        async function importPartite() {
            const url = document.getElementById('sheetUrlPartite').value.trim();
            if (!url) {
                alert('Inserisci URL Google Sheets');
                return;
            }

            const csvUrl = url.replace('/edit#gid=', '/export?format=csv&gid=').replace('/edit?usp=sharing', '/export?format=csv');
            
            Papa.parse(csvUrl, {
                download: true,
                header: true,
                complete: async function(results) {
                    const rows = results.data.filter(row => row.Campo && row.Orario && row.SquadraA && row.SquadraB);
                    
                    if (rows.length === 0) {
                        alert('Nessun dato valido trovato');
                        return;
                    }

                    for (const row of rows) {
                        await supabase.from('partite').insert({
                            campo: parseInt(row.Campo),
                            orario: row.Orario.trim(),
                            squadra_a: row.SquadraA.trim(),
                            squadra_b: row.SquadraB.trim()
                        });
                    }

                    alert(`Importate ${rows.length} partite!`);
                    loadPartite();
                },
                error: function(error) {
                    alert('Errore import: ' + error.message);
                }
            });
        }

        async function aggiungiPartitaManuale() {
            const campo = prompt('Numero campo:');
            if (!campo) return;

            const orario = prompt('Orario (es. 10:30):');
            if (!orario) return;

            const squadraA = prompt('Squadra A:');
            if (!squadraA) return;

            const squadraB = prompt('Squadra B:');
            if (!squadraB) return;

            await supabase.from('partite').insert({
                campo: parseInt(campo),
                orario: orario.trim(),
                squadra_a: squadraA.trim(),
                squadra_b: squadraB.trim()
            });

            loadPartite();
        }

        // ============================================
        // REFERTO PARTITA
        // ============================================
        let currentPartitaId = null;
        let currentPartita = null;
        let giocatoriA = [];
        let giocatoriB = [];

        // Timer variables
        let timerInterval = null;
        let timerSeconds = 900; // 15 minuti = 900 secondi
        let timerRunning = false;
        let currentHalf = 1; // 1 o 2

        async function reloadCurrentReferto() {
            if (!currentPartitaId) return;
            await apriReferto(currentPartitaId);
        }

        function startTimer() {
            if (timerRunning) return;
            timerRunning = true;
            
            timerInterval = setInterval(() => {
                if (timerSeconds > 0) {
                    timerSeconds--;
                    updateTimerDisplay();
                } else {
                    // Tempo scaduto
                    pauseTimer();
                    playBeep();
                    alert(`‚è∞ Fine ${currentHalf}¬∞ Tempo!`);
                }
            }, 1000);
            
            updateTimerButtons();
        }

        function pauseTimer() {
            timerRunning = false;
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            updateTimerButtons();
        }

        function resetTimer() {
            pauseTimer();
            timerSeconds = 900; // Reset a 15 minuti
            updateTimerDisplay();
        }

        function switchHalf() {
            if (!confirm('Passare al 2¬∞ tempo? Il timer sar√† resettato.')) return;
            currentHalf = 2;
            resetTimer();
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const timerEl = document.getElementById('timerDisplay');
            if (timerEl) {
                timerEl.textContent = display;
                
                // Cambio colore se < 1 minuto
                if (timerSeconds < 60) {
                    timerEl.classList.add('text-red-400');
                    timerEl.classList.remove('text-cyan-400');
                } else {
                    timerEl.classList.add('text-cyan-400');
                    timerEl.classList.remove('text-red-400');
                }
            }
            
            const halfEl = document.getElementById('currentHalf');
            if (halfEl) {
                halfEl.textContent = currentHalf === 1 ? '1¬∞ Tempo' : '2¬∞ Tempo';
            }
        }

        function updateTimerButtons() {
            const startBtn = document.getElementById('startTimerBtn');
            const pauseBtn = document.getElementById('pauseTimerBtn');
            
            if (startBtn && pauseBtn) {
                if (timerRunning) {
                    startBtn.classList.add('hidden');
                    pauseBtn.classList.remove('hidden');
                } else {
                    startBtn.classList.remove('hidden');
                    pauseBtn.classList.add('hidden');
                }
            }
        }

        function playBeep() {
            // Beep sonoro semplice
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function renderReferto() {
            if (!currentPartita) return;

            const container = document.getElementById('refertoContent');
            
            container.innerHTML = `
                <!-- Header Partita -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <span class="bg-cyan-500 px-4 py-2 rounded-full font-bold">Campo ${currentPartita.campo}</span>
                        <span class="bg-gray-700 px-4 py-2 rounded-full">${currentPartita.orario}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-4 items-center text-center">
                        <div>
                            <div class="text-xl font-bold mb-2">${currentPartita.squadra_a}</div>
                            <div class="text-5xl font-bold text-cyan-400">${currentPartita.punteggio_a}</div>
                        </div>
                        <div class="text-gray-500 font-bold text-2xl">VS</div>
                        <div>
                            <div class="text-xl font-bold mb-2">${currentPartita.squadra_b}</div>
                            <div class="text-5xl font-bold text-cyan-400">${currentPartita.punteggio_b}</div>
                        </div>
                    </div>
                </div>

                <!-- TIMER PARTITA -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                    <div class="text-center mb-4">
                        <div class="text-sm text-gray-400 mb-2" id="currentHalf">1¬∞ Tempo</div>
                        <div class="text-6xl font-bold text-cyan-400 mb-4 font-mono" id="timerDisplay">15:00</div>
                        <div class="flex gap-3 justify-center flex-wrap">
                            <button id="startTimerBtn" onclick="startTimer()" class="bg-green-500 hover:bg-green-600 px-6 py-3 rounded-lg font-bold transition flex items-center gap-2">
                                ‚ñ∂Ô∏è Avvia
                            </button>
                            <button id="pauseTimerBtn" onclick="pauseTimer()" class="hidden bg-yellow-500 hover:bg-yellow-600 px-6 py-3 rounded-lg font-bold transition flex items-center gap-2">
                                ‚è∏Ô∏è Pausa
                            </button>
                            <button onclick="resetTimer()" class="bg-orange-500 hover:bg-orange-600 px-6 py-3 rounded-lg font-bold transition flex items-center gap-2">
                                üîÑ Reset
                            </button>
                            <button onclick="switchHalf()" class="bg-purple-500 hover:bg-purple-600 px-6 py-3 rounded-lg font-bold transition flex items-center gap-2" ${currentHalf === 2 ? 'disabled' : ''}>
                                ‚è≠Ô∏è 2¬∞ Tempo
                            </button>
                        </div>
                    </div>
                    <div class="text-center text-sm text-gray-400 mt-3">
                        ‚è±Ô∏è Timer: 15 minuti per tempo
                    </div>
                </div>

                <!-- Azioni Primo Tempo -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-bold text-yellow-400 mb-4">‚öΩ Gestione Tempo</h3>
                    <button onclick="azzeraPrimoTempo()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-lg transition mb-2">
                        üîÑ Azzera 1¬∞ Tempo (Reset Vuoti + Rientro Espulsi)
                    </button>
                    <p class="text-sm text-gray-400 text-center">Da usare all'intervallo tra i tempi</p>
                </div>

                <!-- Squadra A -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-bold text-cyan-400 mb-4">${currentPartita.squadra_a}</h3>
                    
                    <!-- Gol -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-yellow-400">‚öΩ Gol</label>
                        <select id="golSelectA" class="w-full bg-gray-700 px-4 py-2 rounded-lg mb-2">
                            <option value="">Seleziona giocatore...</option>
                            ${giocatoriA.map(g => `<option value="${g.nome_giocatore}">${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <button onclick="aggiungiGol('a')" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 rounded-lg transition">
                            Aggiungi Gol
                        </button>
                        <div class="mt-2 text-sm">
                            Marcatori: ${(currentPartita.gol_a || []).join(', ') || 'Nessuno'}
                        </div>
                    </div>

                    <!-- Scalpi -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-red-400">üéØ Scalpi</label>
                        <select id="scalpoSelectA" class="w-full bg-gray-700 px-4 py-2 rounded-lg mb-2">
                            <option value="">Seleziona giocatore...</option>
                            ${giocatoriA.map(g => `<option value="${g.nome_giocatore}">${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <button onclick="aggiungiScalpo('a')" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg transition">
                            Aggiungi Scalpo
                        </button>
                        <div class="mt-2 text-sm">
                            Scalpi: ${(currentPartita.scalpi_a || []).join(', ') || 'Nessuno'}
                        </div>
                    </div>

                    <!-- Vuoti -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-orange-400">‚ùå Vuoti</label>
                        <select id="vuotoSelectA" class="w-full bg-gray-700 px-4 py-2 rounded-lg mb-2">
                            <option value="">Seleziona giocatore...</option>
                            ${giocatoriA.map(g => `<option value="${g.nome_giocatore}">${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <button onclick="aggiungiVuoto('a')" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 rounded-lg transition">
                            Aggiungi Vuoto
                        </button>
                        <div class="mt-2 text-sm">
                            Vuoti: ${(currentPartita.vuoti_a || []).join(', ') || 'Nessuno'}
                        </div>
                    </div>

                    <!-- Espulsi -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-red-600">üö´ Espulsi</label>
                        <div class="bg-gray-700 px-4 py-3 rounded-lg">
                            ${(currentPartita.espulsi_a || []).length > 0 ? 
                                currentPartita.espulsi_a.map(e => `
                                    <div class="flex justify-between items-center mb-2">
                                        <span>${e}</span>
                                        <button onclick="rientroEspulso('a', '${e}')" class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-sm">
                                            Rientro
                                        </button>
                                    </div>
                                `).join('') 
                                : '<span class="text-gray-400">Nessun espulso</span>'}
                        </div>
                    </div>

                    <!-- MVP -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-cyan-400">‚≠ê MVP</label>
                        <select id="mvpSelectA" onchange="aggiungiMVP('a')" class="w-full bg-gray-700 px-4 py-2 rounded-lg">
                            <option value="">Seleziona MVP...</option>
                            ${giocatoriA.map(g => `<option value="${g.nome_giocatore}" ${currentPartita.mvp_a === g.nome_giocatore ? 'selected' : ''}>${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <div class="mt-2 text-sm text-cyan-300">
                            MVP attuale: ${currentPartita.mvp_a || 'Nessuno'}
                        </div>
                    </div>
                </div>

                <!-- Squadra B -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-bold text-cyan-400 mb-4">${currentPartita.squadra_b}</h3>
                    
                    <!-- Gol -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-yellow-400">‚öΩ Gol</label>
                        <select id="golSelectB" class="w-full bg-gray-700 px-4 py-2 rounded-lg mb-2">
                            <option value="">Seleziona giocatore...</option>
                            ${giocatoriB.map(g => `<option value="${g.nome_giocatore}">${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <button onclick="aggiungiGol('b')" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 rounded-lg transition">
                            Aggiungi Gol
                        </button>
                        <div class="mt-2 text-sm">
                            Marcatori: ${(currentPartita.gol_b || []).join(', ') || 'Nessuno'}
                        </div>
                    </div>

                    <!-- Scalpi -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-red-400">üéØ Scalpi</label>
                        <select id="scalpoSelectB" class="w-full bg-gray-700 px-4 py-2 rounded-lg mb-2">
                            <option value="">Seleziona giocatore...</option>
                            ${giocatoriB.map(g => `<option value="${g.nome_giocatore}">${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <button onclick="aggiungiScalpo('b')" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg transition">
                            Aggiungi Scalpo
                        </button>
                        <div class="mt-2 text-sm">
                            Scalpi: ${(currentPartita.scalpi_b || []).join(', ') || 'Nessuno'}
                        </div>
                    </div>

                    <!-- Vuoti -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-orange-400">‚ùå Vuoti</label>
                        <select id="vuotoSelectB" class="w-full bg-gray-700 px-4 py-2 rounded-lg mb-2">
                            <option value="">Seleziona giocatore...</option>
                            ${giocatoriB.map(g => `<option value="${g.nome_giocatore}">${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <button onclick="aggiungiVuoto('b')" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 rounded-lg transition">
                            Aggiungi Vuoto
                        </button>
                        <div class="mt-2 text-sm">
                            Vuoti: ${(currentPartita.vuoti_b || []).join(', ') || 'Nessuno'}
                        </div>
                    </div>

                    <!-- Espulsi -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-red-600">üö´ Espulsi</label>
                        <div class="bg-gray-700 px-4 py-3 rounded-lg">
                            ${(currentPartita.espulsi_b || []).length > 0 ? 
                                currentPartita.espulsi_b.map(e => `
                                    <div class="flex justify-between items-center mb-2">
                                        <span>${e}</span>
                                        <button onclick="rientroEspulso('b', '${e}')" class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-sm">
                                            Rientro
                                        </button>
                                    </div>
                                `).join('') 
                                : '<span class="text-gray-400">Nessun espulso</span>'}
                        </div>
                    </div>

                    <!-- MVP -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-cyan-400">‚≠ê MVP</label>
                        <select id="mvpSelectB" onchange="aggiungiMVP('b')" class="w-full bg-gray-700 px-4 py-2 rounded-lg">
                            <option value="">Seleziona MVP...</option>
                            ${giocatoriB.map(g => `<option value="${g.nome_giocatore}" ${currentPartita.mvp_b === g.nome_giocatore ? 'selected' : ''}>${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <div class="mt-2 text-sm text-cyan-300">
                            MVP attuale: ${currentPartita.mvp_b || 'Nessuno'}
                        </div>
                    </div>
                </div>

                <!-- Finalizza Partita -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <button onclick="finalizzaPartita()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-lg transition text-xl">
                        ‚úì Finalizza Partita
                    </button>
                </div>
            `;
            
            // Inizializza timer display
            updateTimerDisplay();
            updateTimerButtons();
        }

                <!-- Squadra A -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-bold text-cyan-400 mb-4">${currentPartita.squadra_a}</h3>
                    
                    <!-- Gol -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-yellow-400">‚öΩ Gol</label>
                        <select id="golSelectA" class="w-full bg-gray-700 px-4 py-2 rounded-lg mb-2">
                            <option value="">Seleziona giocatore...</option>
                            ${giocatoriA.map(g => `<option value="${g.nome_giocatore}">${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <button onclick="aggiungiGol('a')" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 rounded-lg transition">
                            Aggiungi Gol
                        </button>
                        <div class="mt-2 text-sm">
                            Marcatori: ${(currentPartita.gol_a || []).join(', ') || 'Nessuno'}
                        </div>
                    </div>

                    <!-- Scalpi -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-red-400">üéØ Scalpi</label>
                        <select id="scalpoSelectA" class="w-full bg-gray-700 px-4 py-2 rounded-lg mb-2">
                            <option value="">Seleziona giocatore...</option>
                            ${giocatoriA.map(g => `<option value="${g.nome_giocatore}">${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <button onclick="aggiungiScalpo('a')" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg transition">
                            Aggiungi Scalpo
                        </button>
                        <div class="mt-2 text-sm">
                            Scalpi: ${(currentPartita.scalpi_a || []).join(', ') || 'Nessuno'}
                        </div>
                    </div>

                    <!-- Vuoti -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-orange-400">‚ùå Vuoti</label>
                        <select id="vuotoSelectA" class="w-full bg-gray-700 px-4 py-2 rounded-lg mb-2">
                            <option value="">Seleziona giocatore...</option>
                            ${giocatoriA.map(g => `<option value="${g.nome_giocatore}">${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <button onclick="aggiungiVuoto('a')" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 rounded-lg transition">
                            Aggiungi Vuoto
                        </button>
                        <div class="mt-2 text-sm">
                            Vuoti: ${(currentPartita.vuoti_a || []).join(', ') || 'Nessuno'}
                        </div>
                    </div>

                    <!-- Espulsi -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-red-600">üö´ Espulsi</label>
                        <div class="bg-gray-700 px-4 py-3 rounded-lg">
                            ${(currentPartita.espulsi_a || []).length > 0 ? 
                                currentPartita.espulsi_a.map(e => `
                                    <div class="flex justify-between items-center mb-2">
                                        <span>${e}</span>
                                        <button onclick="rientroEspulso('a', '${e}')" class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-sm">
                                            Rientro
                                        </button>
                                    </div>
                                `).join('') 
                                : '<span class="text-gray-400">Nessun espulso</span>'}
                        </div>
                    </div>

                    <!-- MVP -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-cyan-400">‚≠ê MVP</label>
                        <select id="mvpSelectA" onchange="aggiungiMVP('a')" class="w-full bg-gray-700 px-4 py-2 rounded-lg">
                            <option value="">Seleziona MVP...</option>
                            ${giocatoriA.map(g => `<option value="${g.nome_giocatore}" ${currentPartita.mvp_a === g.nome_giocatore ? 'selected' : ''}>${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <div class="mt-2 text-sm text-cyan-300">
                            MVP attuale: ${currentPartita.mvp_a || 'Nessuno'}
                        </div>
                    </div>
                </div>

                <!-- Squadra B -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-bold text-cyan-400 mb-4">${currentPartita.squadra_b}</h3>
                    
                    <!-- Gol -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-yellow-400">‚öΩ Gol</label>
                        <select id="golSelectB" class="w-full bg-gray-700 px-4 py-2 rounded-lg mb-2">
                            <option value="">Seleziona giocatore...</option>
                            ${giocatoriB.map(g => `<option value="${g.nome_giocatore}">${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <button onclick="aggiungiGol('b')" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 rounded-lg transition">
                            Aggiungi Gol
                        </button>
                        <div class="mt-2 text-sm">
                            Marcatori: ${(currentPartita.gol_b || []).join(', ') || 'Nessuno'}
                        </div>
                    </div>

                    <!-- Scalpi -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-red-400">üéØ Scalpi</label>
                        <select id="scalpoSelectB" class="w-full bg-gray-700 px-4 py-2 rounded-lg mb-2">
                            <option value="">Seleziona giocatore...</option>
                            ${giocatoriB.map(g => `<option value="${g.nome_giocatore}">${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <button onclick="aggiungiScalpo('b')" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg transition">
                            Aggiungi Scalpo
                        </button>
                        <div class="mt-2 text-sm">
                            Scalpi: ${(currentPartita.scalpi_b || []).join(', ') || 'Nessuno'}
                        </div>
                    </div>

                    <!-- Vuoti -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-orange-400">‚ùå Vuoti</label>
                        <select id="vuotoSelectB" class="w-full bg-gray-700 px-4 py-2 rounded-lg mb-2">
                            <option value="">Seleziona giocatore...</option>
                            ${giocatoriB.map(g => `<option value="${g.nome_giocatore}">${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <button onclick="aggiungiVuoto('b')" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 rounded-lg transition">
                            Aggiungi Vuoto
                        </button>
                        <div class="mt-2 text-sm">
                            Vuoti: ${(currentPartita.vuoti_b || []).join(', ') || 'Nessuno'}
                        </div>
                    </div>

                    <!-- Espulsi -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-red-600">üö´ Espulsi</label>
                        <div class="bg-gray-700 px-4 py-3 rounded-lg">
                            ${(currentPartita.espulsi_b || []).length > 0 ? 
                                currentPartita.espulsi_b.map(e => `
                                    <div class="flex justify-between items-center mb-2">
                                        <span>${e}</span>
                                        <button onclick="rientroEspulso('b', '${e}')" class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-sm">
                                            Rientro
                                        </button>
                                    </div>
                                `).join('') 
                                : '<span class="text-gray-400">Nessun espulso</span>'}
                        </div>
                    </div>

                    <!-- MVP -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-cyan-400">‚≠ê MVP</label>
                        <select id="mvpSelectB" onchange="aggiungiMVP('b')" class="w-full bg-gray-700 px-4 py-2 rounded-lg">
                            <option value="">Seleziona MVP...</option>
                            ${giocatoriB.map(g => `<option value="${g.nome_giocatore}" ${currentPartita.mvp_b === g.nome_giocatore ? 'selected' : ''}>${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <div class="mt-2 text-sm text-cyan-300">
                            MVP attuale: ${currentPartita.mvp_b || 'Nessuno'}
                        </div>
                    </div>
                </div>

                <!-- Finalizza Partita -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <button onclick="finalizzaPartita()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-lg transition text-xl">
                        ‚úì Finalizza Partita
                    </button>
                </div>
            `;
        }

        async function aggiungiGol(squadra) {
            const select = document.getElementById(`golSelect${squadra.toUpperCase()}`);
            const giocatore = select.value;
            if (!giocatore) return;

            const field = squadra === 'a' ? 'gol_a' : 'gol_b';
            const scoreField = squadra === 'a' ? 'punteggio_a' : 'punteggio_b';
            
            const gol = [...(currentPartita[field] || []), giocatore];
            
            await supabase
                .from('partite')
                .update({ 
                    [field]: gol,
                    [scoreField]: gol.length
                })
                .eq('id', currentPartitaId);

            select.value = '';
            await reloadCurrentReferto();
        }

        async function aggiungiScalpo(squadra) {
            const select = document.getElementById(`scalpoSelect${squadra.toUpperCase()}`);
            const giocatore = select.value;
            if (!giocatore) return;

            const field = squadra === 'a' ? 'scalpi_a' : 'scalpi_b';
            const scalpi = [...(currentPartita[field] || []), giocatore];
            
            await supabase
                .from('partite')
                .update({ [field]: scalpi })
                .eq('id', currentPartitaId);

            select.value = '';
            await reloadCurrentReferto();
        }

        async function aggiungiVuoto(squadra) {
            const select = document.getElementById(`vuotoSelect${squadra.toUpperCase()}`);
            const giocatore = select.value;
            if (!giocatore) return;

            const vuotiField = squadra === 'a' ? 'vuoti_a' : 'vuoti_b';
            const espulsiField = squadra === 'a' ? 'espulsi_a' : 'espulsi_b';
            
            const vuoti = [...(currentPartita[vuotiField] || []), giocatore];
            
            // Conta vuoti del giocatore
            const countVuoti = vuoti.filter(v => v === giocatore).length;
            
            let update = { [vuotiField]: vuoti };
            
            // Se 3¬∞ vuoto ‚Üí espulsione automatica
            if (countVuoti >= 3) {
                const espulsi = [...(currentPartita[espulsiField] || [])];
                if (!espulsi.includes(giocatore)) {
                    espulsi.push(giocatore);
                    update[espulsiField] = espulsi;
                    alert(`‚ö†Ô∏è ${giocatore} ESPULSO per 3 vuoti!`);
                }
            }
            
            await supabase
                .from('partite')
                .update(update)
                .eq('id', currentPartitaId);

            select.value = '';
            await reloadCurrentReferto();
        }

        async function rientroEspulso(squadra, giocatore) {
            const field = squadra === 'a' ? 'espulsi_a' : 'espulsi_b';
            const espulsi = (currentPartita[field] || []).filter(e => e !== giocatore);
            
            await supabase
                .from('partite')
                .update({ [field]: espulsi })
                .eq('id', currentPartitaId);

            await reloadCurrentReferto();
        }

        async function azzeraPrimoTempo() {
            if (!confirm('Azzerare vuoti e far rientrare tutti gli espulsi?')) return;

            await supabase
                .from('partite')
                .update({
                    vuoti_a: [],
                    vuoti_b: [],
                    espulsi_a: [],
                    espulsi_b: []
                })
                .eq('id', currentPartitaId);

            alert('‚úì Primo tempo azzerato! Tutti rientrati.');
            await reloadCurrentReferto();
        }

        async function aggiungiMVP(squadra) {
            const select = document.getElementById(`mvpSelect${squadra.toUpperCase()}`);
            const giocatore = select.value;
            
            const field = squadra === 'a' ? 'mvp_a' : 'mvp_b';
            
            await supabase
                .from('partite')
                .update({ [field]: giocatore })
                .eq('id', currentPartitaId);

            await reloadCurrentReferto();
        }

        async function finalizzaPartita() {
            if (!currentPartita.mvp_a || !currentPartita.mvp_b) {
                alert('‚ö†Ô∏è Seleziona MVP per entrambe le squadre!');
                return;
            }

            if (!confirm('Finalizzare la partita? Non sar√† pi√π modificabile.')) return;

            const punteggioA = currentPartita.punteggio_a;
            const punteggioB = currentPartita.punteggio_b;

            let puntiA = 0, puntiB = 0;

            if (punteggioA > punteggioB) {
                puntiA = 3;
                puntiB = 0;
            } else if (punteggioB > punteggioA) {
                puntiA = 0;
                puntiB = 3;
            } else {
                puntiA = 1;
                puntiB = 1;
            }

            await supabase
                .from('partite')
                .update({
                    punti_a: puntiA,
                    punti_b: puntiB,
                    completata: true
                })
                .eq('id', currentPartitaId);

            alert('‚úì Partita finalizzata!');
            tornaAllePartite();
        }ione automatica
            if (countVuoti >= 3) {
                const espulsi = [...(currentPartita[espulsiField] || [])];
                if (!espulsi.includes(giocatore)) {
                    espulsi.push(giocatore);
                    update[espulsiField] = espulsi;
                    alert(`‚ö†Ô∏è ${giocatore} ESPULSO per 3 vuoti!`);
                }
            }
            
            await supabase
                .from('partite')
                .update(update)
                .eq('id', currentPartitaId);

            select.value = '';
            await loadReferto();
        }

        async function rientroEspulso(squadra, giocatore) {
            const field = squadra === 'a' ? 'espulsi_a' : 'espulsi_b';
            const espulsi = (currentPartita[field] || []).filter(e => e !== giocatore);
            
            await supabase
                .from('partite')
                .update({ [field]: espulsi })
                .eq('id', currentPartitaId);

            await loadReferto();
        }

        async function azzeraPrimoTempo() {
            if (!confirm('Azzerare vuoti e far rientrare tutti gli espulsi?')) return;

            await supabase
                .from('partite')
                .update({
                    vuoti_a: [],
                    vuoti_b: [],
                    espulsi_a: [],
                    espulsi_b: []
                })
                .eq('id', currentPartitaId);

            alert('‚úì Primo tempo azzerato! Tutti rientrati.');
            await loadReferto();
        }

        async function aggiungiMVP(squadra) {
            const select = document.getElementById(`mvpSelect${squadra.toUpperCase()}`);
            const giocatore = select.value;
            
            const field = squadra === 'a' ? 'mvp_a' : 'mvp_b';
            
            await supabase
                .from('partite')
                .update({ [field]: giocatore })
                .eq('id', currentPartitaId);

            await loadReferto();
        }

        async function finalizzaPartita() {
            if (!currentPartita.mvp_a || !currentPartita.mvp_b) {
                alert('‚ö†Ô∏è Seleziona MVP per entrambe le squadre!');
                return;
            }

            if (!confirm('Finalizzare la partita? Non sar√† pi√π modificabile.')) return;

            const punteggioA = currentPartita.punteggio_a;
            const punteggioB = currentPartita.punteggio_b;

            let puntiA = 0, puntiB = 0;

            if (punteggioA > punteggioB) {
                puntiA = 3;
                puntiB = 0;
            } else if (punteggioB > punteggioA) {
                puntiA = 0;
                puntiB = 3;
            } else {
                puntiA = 1;
                puntiB = 1;
            }

            await supabase
                .from('partite')
                .update({
                    punti_a: puntiA,
                    punti_b: puntiB,
                    completata: true
                })
                .eq('id', currentPartitaId);

            alert('‚úì Partita finalizzata!');
            document.getElementById('selectPartitaReferto').value = '';
            document.getElementById('refertoContent').innerHTML = '';
            loadPartiteSelect();
            loadPartite();
        }

        // ============================================
        // CLASSIFICHE
        // ============================================
        async function loadClassifiche() {
            const { data: partite } = await supabase
                .from('partite')
                .select('*')
                .eq('completata', true);

            // Classifica Generale
            const classifica = {};
            partite.forEach(p => {
                if (!classifica[p.squadra_a]) {
                    classifica[p.squadra_a] = { g: 0, v: 0, n: 0, p: 0, gf: 0, gs: 0, pt: 0 };
                }
                if (!classifica[p.squadra_b]) {
                    classifica[p.squadra_b] = { g: 0, v: 0, n: 0, p: 0, gf: 0, gs: 0, pt: 0 };
                }

                classifica[p.squadra_a].g++;
                classifica[p.squadra_b].g++;
                classifica[p.squadra_a].gf += p.punteggio_a;
                classifica[p.squadra_a].gs += p.punteggio_b;
                classifica[p.squadra_b].gf += p.punteggio_b;
                classifica[p.squadra_b].gs += p.punteggio_a;
                classifica[p.squadra_a].pt += p.punti_a;
                classifica[p.squadra_b].pt += p.punti_b;

                if (p.punti_a === 3) classifica[p.squadra_a].v++;
                else if (p.punti_a === 1) classifica[p.squadra_a].n++;
                else classifica[p.squadra_a].p++;

                if (p.punti_b === 3) classifica[p.squadra_b].v++;
                else if (p.punti_b === 1) classifica[p.squadra_b].n++;
                else classifica[p.squadra_b].p++;
            });

            const classificaArray = Object.keys(classifica).map(team => ({
                team,
                ...classifica[team],
                dr: classifica[team].gf - classifica[team].gs
            })).sort((a, b) => b.pt - a.pt || b.dr - a.dr);

            const tbody = document.getElementById('classificaGenerale');
            tbody.innerHTML = classificaArray.map((c, i) => `
                <tr class="border-b border-gray-700 hover:bg-gray-700">
                    <td class="px-4 py-3 font-bold">${i + 1}</td>
                    <td class="px-4 py-3">${c.team}</td>
                    <td class="px-4 py-3 text-center font-bold text-cyan-400">${c.pt}</td>
                    <td class="px-4 py-3 text-center">${c.g}</td>
                    <td class="px-4 py-3 text-center text-green-400">${c.v}</td>
                    <td class="px-4 py-3 text-center text-yellow-400">${c.n}</td>
                    <td class="px-4 py-3 text-center text-red-400">${c.p}</td>
                    <td class="px-4 py-3 text-center">${c.gf}</td>
                    <td class="px-4 py-3 text-center">${c.gs}</td>
                    <td class="px-4 py-3 text-center ${c.dr > 0 ? 'text-green-400' : c.dr < 0 ? 'text-red-400' : ''}">${c.dr > 0 ? '+' : ''}${c.dr}</td>
                </tr>
            `).join('');

            // Top Marcatori
            const marcatori = {};
            partite.forEach(p => {
                (p.gol_a || []).forEach(g => marcatori[g] = (marcatori[g] || 0) + 1);
                (p.gol_b || []).forEach(g => marcatori[g] = (marcatori[g] || 0) + 1);
            });
            const topMarcatori = Object.keys(marcatori)
                .map(g => ({ name: g, gol: marcatori[g] }))
                .sort((a, b) => b.gol - a.gol)
                .slice(0, 10);

            document.getElementById('topMarcatori').innerHTML = topMarcatori.map((m, i) => `
                <div class="flex justify-between items-center bg-gray-700 px-4 py-2 rounded">
                    <span><span class="font-bold text-yellow-400">${i + 1}.</span> ${m.name}</span>
                    <span class="bg-yellow-400 text-gray-900 px-3 py-1 rounded font-bold">${m.gol} ‚öΩ</span>
                </div>
            `).join('');

            // Top Scalpiatori
            const scalpiatori = {};
            partite.forEach(p => {
                (p.scalpi_a || []).forEach(s => scalpiatori[s] = (scalpiatori[s] || 0) + 1);
                (p.scalpi_b || []).forEach(s => scalpiatori[s] = (scalpiatori[s] || 0) + 1);
            });
            const topScalpiatori = Object.keys(scalpiatori)
                .map(s => ({ name: s, scalpi: scalpiatori[s] }))
                .sort((a, b) => b.scalpi - a.scalpi)
                .slice(0, 10);

            document.getElementById('topScalpiatori').innerHTML = topScalpiatori.map((s, i) => `
                <div class="flex justify-between items-center bg-gray-700 px-4 py-2 rounded">
                    <span><span class="font-bold text-red-400">${i + 1}.</span> ${s.name}</span>
                    <span class="bg-red-400 text-white px-3 py-1 rounded font-bold">${s.scalpi} üéØ</span>
                </div>
            `).join('');

            // Top Vuotatori
            const vuotatori = {};
            partite.forEach(p => {
                (p.vuoti_a || []).forEach(v => vuotatori[v] = (vuotatori[v] || 0) + 1);
                (p.vuoti_b || []).forEach(v => vuotatori[v] = (vuotatori[v] || 0) + 1);
            });
            const topVuotatori = Object.keys(vuotatori)
                .map(v => ({ name: v, vuoti: vuotatori[v] }))
                .sort((a, b) => b.vuoti - a.vuoti)
                .slice(0, 10);

            document.getElementById('topVuotatori').innerHTML = topVuotatori.map((v, i) => `
                <div class="flex justify-between items-center bg-gray-700 px-4 py-2 rounded">
                    <span><span class="font-bold text-orange-400">${i + 1}.</span> ${v.name}</span>
                    <span class="bg-orange-400 text-white px-3 py-1 rounded font-bold">${v.vuoti} ‚ùå</span>
                </div>
            `).join('');

            // Top MVP
            const mvps = {};
            partite.forEach(p => {
                if (p.mvp_a) mvps[p.mvp_a] = (mvps[p.mvp_a] || 0) + 1;
                if (p.mvp_b) mvps[p.mvp_b] = (mvps[p.mvp_b] || 0) + 1;
            });
            const topMVPs = Object.keys(mvps)
                .map(m => ({ name: m, count: mvps[m] }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            document.getElementById('topMVP').innerHTML = topMVPs.map((m, i) => `
                <div class="flex justify-between items-center bg-gray-700 px-4 py-2 rounded">
                    <span><span class="font-bold text-cyan-400">${i + 1}.</span> ${m.name}</span>
                    <span class="bg-cyan-400 text-gray-900 px-3 py-1 rounded font-bold">${m.count} ‚≠ê</span>
                </div>
            `).join('');
        }

        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            
            document.getElementById('emailInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });
        });
    </script>
</body>
</html>
