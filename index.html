<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24OdG - Torneo Pallascout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#111827">
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    
    <!-- Login Screen -->
    <div id="loginScreen" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 max-w-md w-full">
            <h1 class="text-3xl font-bold text-cyan-400 mb-6 text-center">‚öΩ 24 Ore delle Grazie</h1>
            <p class="text-gray-300 mb-6 text-center">Accedi con email autorizzata</p>
            <input type="email" id="emailInput" placeholder="email@arbitro.it" 
                   class="w-full bg-gray-700 text-white px-4 py-3 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-cyan-400">
            <button onclick="login()" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 rounded-lg transition">
                Accedi
            </button>
            <p id="loginError" class="text-red-400 text-sm mt-4 text-center hidden"></p>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-gray-800 shadow-lg sticky top-0 z-50">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-cyan-400">‚öΩ 24OdG</h1>
                <div class="flex items-center gap-4">
                    <span id="userEmailDisplay" class="text-gray-300 text-sm"></span>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg text-sm transition">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-gray-800 border-t border-gray-700">
            <div class="container mx-auto px-4 flex overflow-x-auto">
                <button onclick="showSection('squadre')" class="nav-btn px-6 py-3 whitespace-nowrap hover:bg-gray-700 transition">
                    üë• Squadre
                </button>
                <button onclick="showSection('partite')" class="nav-btn px-6 py-3 whitespace-nowrap hover:bg-gray-700 transition">
                    üìã Partite
                </button>
                <button onclick="showSection('referto')" class="nav-btn px-6 py-3 whitespace-nowrap hover:bg-gray-700 transition">
                    ‚öΩ Referto
                </button>
                <button onclick="showSection('classifiche')" class="nav-btn px-6 py-3 whitespace-nowrap hover:bg-gray-700 transition">
                    üèÜ Classifiche
                </button>
            </div>
        </nav>

        <!-- Sections Container -->
        <div class="container mx-auto px-4 py-6">
            
            <!-- SQUADRE SECTION -->
            <div id="squadreSection" class="section">
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold text-cyan-400 mb-4">üë• Gestione Squadre</h2>
                    <div class="flex flex-wrap gap-3 mb-4">
                        <input type="text" id="sheetUrlSquadre" placeholder="URL Google Sheets" 
                               class="flex-1 min-w-[200px] bg-gray-700 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-400">
                        <button onclick="importSquadre()" class="bg-green-500 hover:bg-green-600 px-6 py-2 rounded-lg transition">
                            üì• Import Squadre
                        </button>
                        <button onclick="aggiungiSquadraManuale()" class="bg-cyan-500 hover:bg-cyan-600 px-6 py-2 rounded-lg transition">
                            ‚ûï Aggiungi Manuale
                        </button>
                    </div>
                </div>
                
                <div id="squadreList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- PARTITE SECTION -->
            <div id="partiteSection" class="section hidden">
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold text-cyan-400 mb-4">üìã Gestione Partite</h2>
                    <div class="flex flex-wrap gap-3 mb-4">
                        <input type="text" id="sheetUrlPartite" placeholder="URL Google Sheets" 
                               class="flex-1 min-w-[200px] bg-gray-700 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-400">
                        <button onclick="importPartite()" class="bg-green-500 hover:bg-green-600 px-6 py-2 rounded-lg transition">
                            üì• Import Partite
                        </button>
                        <button onclick="aggiungiPartitaManuale()" class="bg-cyan-500 hover:bg-cyan-600 px-6 py-2 rounded-lg transition">
                            ‚ûï Aggiungi Manuale
                        </button>
                    </div>

                    <!-- Filtri Partite -->
                    <div class="flex flex-wrap gap-3 mb-4">
                        <select id="filtroCampo" onchange="loadPartite()" class="bg-gray-700 px-4 py-2 rounded-lg">
                            <option value="">Tutti i campi</option>
                        </select>
                        <select id="filtroOrario" onchange="loadPartite()" class="bg-gray-700 px-4 py-2 rounded-lg">
                            <option value="">Tutti gli orari</option>
                        </select>
                        <select id="filtroStato" onchange="loadPartite()" class="bg-gray-700 px-4 py-2 rounded-lg">
                            <option value="tutte">Tutte</option>
                            <option value="daGiocare">Da Giocare</option>
                            <option value="completate">Completate</option>
                        </select>
                    </div>
                </div>
                
                <div id="partiteList" class="space-y-4"></div>
            </div>

            <!-- REFERTO SECTION -->
            <div id="refertoSection" class="section hidden">
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold text-cyan-400 mb-4">‚öΩ Referto Partita</h2>
                    <select id="selectPartitaReferto" onchange="loadReferto()" class="w-full bg-gray-700 px-4 py-2 rounded-lg mb-4">
                        <option value="">Seleziona partita...</option>
                    </select>
                </div>
                
                <div id="refertoContent"></div>
            </div>

            <!-- CLASSIFICHE SECTION -->
            <div id="classificheSection" class="section hidden">
                <div class="space-y-6">
                    <!-- Classifica Generale -->
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-cyan-400 mb-4">üèÜ Classifica Generale</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th class="px-4 py-2 text-left">#</th>
                                        <th class="px-4 py-2 text-left">Squadra</th>
                                        <th class="px-4 py-2 text-center">PT</th>
                                        <th class="px-4 py-2 text-center">G</th>
                                        <th class="px-4 py-2 text-center">V</th>
                                        <th class="px-4 py-2 text-center">N</th>
                                        <th class="px-4 py-2 text-center">P</th>
                                        <th class="px-4 py-2 text-center">GF</th>
                                        <th class="px-4 py-2 text-center">GS</th>
                                        <th class="px-4 py-2 text-center">DR</th>
                                    </tr>
                                </thead>
                                <tbody id="classificaGenerale"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Marcatori -->
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-yellow-400 mb-4">‚öΩ Top Marcatori</h2>
                        <div id="topMarcatori" class="space-y-2"></div>
                    </div>

                    <!-- Scalpiatori -->
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-red-400 mb-4">üéØ Top Scalpiatori</h2>
                        <div id="topScalpiatori" class="space-y-2"></div>
                    </div>

                    <!-- Vuotatori -->
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-orange-400 mb-4">‚ùå Top Vuotatori</h2>
                        <div id="topVuotatori" class="space-y-2"></div>
                    </div>

                    <!-- MVP -->
                    <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-cyan-400 mb-4">‚≠ê Top MVP</h2>
                        <div id="topMVP" class="space-y-2"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURAZIONE SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://bflagmexshprrbigcjzj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmbGFnbWV4c2hwcnJiaWdjanpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk2OTk5ODksImV4cCI6MjA0NTI3NTk4OX0.xQdwqXmLvEKkOqmkJZkfvVnGZ5ILqRzUwLmYHq3pMWg';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ============================================
        // WHITELIST EMAIL ARBITRI
        // ============================================
        const ARBITRI_AUTORIZZATI = [
            'stepengo@gmail.com',
            'arbitro1@24odg.it',
            'arbitro2@24odg.it',
            'test@24odg.test'  // Email di test
        ];

        // ============================================
        // AUTENTICAZIONE
        // ============================================
        function checkAuth() {
            const userEmail = localStorage.getItem('userEmail');
            if (userEmail && ARBITRI_AUTORIZZATI.includes(userEmail)) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userEmailDisplay').textContent = userEmail;
                loadSquadre();
                loadPartite();
                showSection('squadre');
            } else {
                localStorage.removeItem('userEmail');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        }

        function login() {
            const email = document.getElementById('emailInput').value.trim().toLowerCase();
            const errorEl = document.getElementById('loginError');
            
            if (!email) {
                errorEl.textContent = 'Inserisci un\'email valida';
                errorEl.classList.remove('hidden');
                return;
            }

            if (ARBITRI_AUTORIZZATI.includes(email)) {
                localStorage.setItem('userEmail', email);
                errorEl.classList.add('hidden');
                checkAuth();
            } else {
                errorEl.textContent = 'Email non autorizzata';
                errorEl.classList.remove('hidden');
            }
        }

        function logout() {
            if (confirm('Vuoi uscire?')) {
                localStorage.removeItem('userEmail');
                checkAuth();
            }
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-gray-700', 'text-cyan-400', 'border-b-2', 'border-cyan-400');
            });
            event.target.classList.add('bg-gray-700', 'text-cyan-400', 'border-b-2', 'border-cyan-400');

            if (sectionName === 'classifiche') {
                loadClassifiche();
            }
            if (sectionName === 'referto') {
                loadPartiteSelect();
            }
        }

        // ============================================
        // GESTIONE SQUADRE
        // ============================================
        async function loadSquadre() {
            const { data, error } = await supabase
                .from('squadre')
                .select('*')
                .order('nome_squadra', { ascending: true })
                .order('numero', { ascending: true });

            if (error) {
                console.error('Errore caricamento squadre:', error);
                return;
            }

            const squadreByTeam = {};
            data.forEach(row => {
                if (!squadreByTeam[row.nome_squadra]) {
                    squadreByTeam[row.nome_squadra] = [];
                }
                squadreByTeam[row.nome_squadra].push(row);
            });

            const container = document.getElementById('squadreList');
            container.innerHTML = '';

            Object.keys(squadreByTeam).forEach(teamName => {
                const players = squadreByTeam[teamName];
                const card = document.createElement('div');
                card.className = 'bg-gray-800 rounded-lg shadow-lg p-4';
                card.innerHTML = `
                    <h3 class="text-xl font-bold text-cyan-400 mb-3">${teamName}</h3>
                    <div class="space-y-2">
                        ${players.map(p => `
                            <div class="flex items-center gap-2 bg-gray-700 px-3 py-2 rounded">
                                <span class="bg-cyan-500 text-white font-bold px-2 py-1 rounded text-sm">${p.numero}</span>
                                <span>${p.nome_giocatore}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function importSquadre() {
            const url = document.getElementById('sheetUrlSquadre').value.trim();
            if (!url) {
                alert('Inserisci URL Google Sheets');
                return;
            }

            const csvUrl = url.replace('/edit#gid=', '/export?format=csv&gid=').replace('/edit?usp=sharing', '/export?format=csv');
            
            Papa.parse(csvUrl, {
                download: true,
                header: true,
                complete: async function(results) {
                    const rows = results.data.filter(row => row.Squadra && row.Numero && row.Nome);
                    
                    if (rows.length === 0) {
                        alert('Nessun dato valido trovato');
                        return;
                    }

                    for (const row of rows) {
                        await supabase.from('squadre').insert({
                            nome_squadra: row.Squadra.trim(),
                            numero: parseInt(row.Numero),
                            nome_giocatore: row.Nome.trim()
                        });
                    }

                    alert(`Importate ${rows.length} righe!`);
                    loadSquadre();
                },
                error: function(error) {
                    alert('Errore import: ' + error.message);
                }
            });
        }

        async function aggiungiSquadraManuale() {
            const nomeSquadra = prompt('Nome squadra:');
            if (!nomeSquadra) return;

            while (true) {
                const numero = prompt('Numero maglia (lascia vuoto per finire):');
                if (!numero) break;

                const nome = prompt('Nome giocatore:');
                if (!nome) break;

                await supabase.from('squadre').insert({
                    nome_squadra: nomeSquadra.trim(),
                    numero: parseInt(numero),
                    nome_giocatore: nome.trim()
                });
            }

            loadSquadre();
        }

        // ============================================
        // GESTIONE PARTITE
        // ============================================
        async function loadPartite() {
            let query = supabase.from('partite').select('*').order('campo').order('orario');

            const filtroCampo = document.getElementById('filtroCampo').value;
            const filtroOrario = document.getElementById('filtroOrario').value;
            const filtroStato = document.getElementById('filtroStato').value;

            if (filtroCampo) query = query.eq('campo', parseInt(filtroCampo));
            if (filtroOrario) query = query.eq('orario', filtroOrario);
            if (filtroStato === 'daGiocare') query = query.eq('completata', false);
            if (filtroStato === 'completate') query = query.eq('completata', true);

            const { data, error } = await query;

            if (error) {
                console.error('Errore caricamento partite:', error);
                return;
            }

            // Popola filtri
            const campi = [...new Set(data.map(p => p.campo))].sort((a,b) => a-b);
            const orari = [...new Set(data.map(p => p.orario))].sort();

            const filtroCampoEl = document.getElementById('filtroCampo');
            const currentCampo = filtroCampoEl.value;
            filtroCampoEl.innerHTML = '<option value="">Tutti i campi</option>' +
                campi.map(c => `<option value="${c}" ${c == currentCampo ? 'selected' : ''}>Campo ${c}</option>`).join('');

            const filtroOrarioEl = document.getElementById('filtroOrario');
            const currentOrario = filtroOrarioEl.value;
            filtroOrarioEl.innerHTML = '<option value="">Tutti gli orari</option>' +
                orari.map(o => `<option value="${o}" ${o == currentOrario ? 'selected' : ''}>${o}</option>`).join('');

            // Mostra partite
            const container = document.getElementById('partiteList');
            container.innerHTML = '';

            data.forEach(partita => {
                const card = document.createElement('div');
                card.className = `bg-gray-800 rounded-lg shadow-lg p-4 ${partita.completata ? 'opacity-60' : ''}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="bg-cyan-500 px-3 py-1 rounded-full text-sm font-bold">Campo ${partita.campo}</span>
                            <span class="bg-gray-700 px-3 py-1 rounded-full text-sm ml-2">${partita.orario}</span>
                        </div>
                        ${partita.completata ? '<span class="bg-green-500 px-3 py-1 rounded-full text-sm">‚úì Completata</span>' : ''}
                    </div>
                    <div class="grid grid-cols-3 gap-4 items-center">
                        <div class="text-right">
                            <div class="font-bold text-lg">${partita.squadra_a}</div>
                            <div class="text-3xl font-bold text-cyan-400">${partita.punteggio_a}</div>
                        </div>
                        <div class="text-center text-gray-500 font-bold">VS</div>
                        <div class="text-left">
                            <div class="font-bold text-lg">${partita.squadra_b}</div>
                            <div class="text-3xl font-bold text-cyan-400">${partita.punteggio_b}</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function importPartite() {
            const url = document.getElementById('sheetUrlPartite').value.trim();
            if (!url) {
                alert('Inserisci URL Google Sheets');
                return;
            }

            const csvUrl = url.replace('/edit#gid=', '/export?format=csv&gid=').replace('/edit?usp=sharing', '/export?format=csv');
            
            Papa.parse(csvUrl, {
                download: true,
                header: true,
                complete: async function(results) {
                    const rows = results.data.filter(row => row.Campo && row.Orario && row.SquadraA && row.SquadraB);
                    
                    if (rows.length === 0) {
                        alert('Nessun dato valido trovato');
                        return;
                    }

                    for (const row of rows) {
                        await supabase.from('partite').insert({
                            campo: parseInt(row.Campo),
                            orario: row.Orario.trim(),
                            squadra_a: row.SquadraA.trim(),
                            squadra_b: row.SquadraB.trim()
                        });
                    }

                    alert(`Importate ${rows.length} partite!`);
                    loadPartite();
                },
                error: function(error) {
                    alert('Errore import: ' + error.message);
                }
            });
        }

        async function aggiungiPartitaManuale() {
            const campo = prompt('Numero campo:');
            if (!campo) return;

            const orario = prompt('Orario (es. 10:30):');
            if (!orario) return;

            const squadraA = prompt('Squadra A:');
            if (!squadraA) return;

            const squadraB = prompt('Squadra B:');
            if (!squadraB) return;

            await supabase.from('partite').insert({
                campo: parseInt(campo),
                orario: orario.trim(),
                squadra_a: squadraA.trim(),
                squadra_b: squadraB.trim()
            });

            loadPartite();
        }

        // ============================================
        // REFERTO PARTITA
        // ============================================
        let currentPartitaId = null;
        let currentPartita = null;
        let giocatoriA = [];
        let giocatoriB = [];

        async function loadPartiteSelect() {
            const { data } = await supabase
                .from('partite')
                .select('*')
                .eq('completata', false)
                .order('campo')
                .order('orario');

            const select = document.getElementById('selectPartitaReferto');
            select.innerHTML = '<option value="">Seleziona partita...</option>' +
                data.map(p => `<option value="${p.id}">Campo ${p.campo} - ${p.orario} - ${p.squadra_a} vs ${p.squadra_b}</option>`).join('');
        }

        async function loadReferto() {
            const partitaId = document.getElementById('selectPartitaReferto').value;
            if (!partitaId) {
                document.getElementById('refertoContent').innerHTML = '';
                return;
            }

            currentPartitaId = partitaId;

            const { data: partita } = await supabase
                .from('partite')
                .select('*')
                .eq('id', partitaId)
                .single();

            currentPartita = partita;

            const { data: squadraAData } = await supabase
                .from('squadre')
                .select('*')
                .eq('nome_squadra', partita.squadra_a)
                .order('numero');

            const { data: squadraBData } = await supabase
                .from('squadre')
                .select('*')
                .eq('nome_squadra', partita.squadra_b)
                .order('numero');

            giocatoriA = squadraAData || [];
            giocatoriB = squadraBData || [];

            renderReferto();
        }

        function renderReferto() {
            if (!currentPartita) return;

            const container = document.getElementById('refertoContent');
            
            container.innerHTML = `
                <!-- Header Partita -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <span class="bg-cyan-500 px-4 py-2 rounded-full font-bold">Campo ${currentPartita.campo}</span>
                        <span class="bg-gray-700 px-4 py-2 rounded-full">${currentPartita.orario}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-4 items-center text-center">
                        <div>
                            <div class="text-xl font-bold mb-2">${currentPartita.squadra_a}</div>
                            <div class="text-5xl font-bold text-cyan-400">${currentPartita.punteggio_a}</div>
                        </div>
                        <div class="text-gray-500 font-bold text-2xl">VS</div>
                        <div>
                            <div class="text-xl font-bold mb-2">${currentPartita.squadra_b}</div>
                            <div class="text-5xl font-bold text-cyan-400">${currentPartita.punteggio_b}</div>
                        </div>
                    </div>
                </div>

                <!-- Azioni Primo Tempo -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-bold text-yellow-400 mb-4">‚öΩ Primo Tempo</h3>
                    <button onclick="azzeraPrimoTempo()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-lg transition mb-4">
                        üîÑ Azzera 1¬∞ Tempo (Reset Vuoti + Rientro Espulsi)
                    </button>
                </div>

                <!-- Squadra A -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-bold text-cyan-400 mb-4">${currentPartita.squadra_a}</h3>
                    
                    <!-- Gol -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-yellow-400">‚öΩ Gol</label>
                        <select id="golSelectA" class="w-full bg-gray-700 px-4 py-2 rounded-lg mb-2">
                            <option value="">Seleziona giocatore...</option>
                            ${giocatoriA.map(g => `<option value="${g.nome_giocatore}">${g.numero} - ${g.nome_giocatore}</option>`).join('')}
                        </select>
                        <button onclick="aggiungiGol('a')" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 rounded-lg transition">
                            Aggiungi Gol
                        </button>
                        <div class="mt-2 text-sm">
                            Marcatori: ${(currentPartita.gol_a || []).join(', ') || 'Nessuno'}
                        </div>
                    </div>

                    <!-- Scalpi -->
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-red-400">üéØ Scalpi</label>
                        <select id="scalpoSelectA" class="w-full bg-gray-700 px-4
